{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header and Action Buttons -->
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
        <h4 class="fw-bold mb-0 me-3 flex-shrink-0">ES Reports</h4>
        <div class="d-flex align-items-center ms-auto flex-wrap gap-2">
          <form method="POST" action="{{ url_for('set_reports_scheme') }}" class="d-flex align-items-center me-2 flex-wrap gap-2">
        <div class="input-group input-group-sm me-2">
          <label class="input-group-text" for="scheme_select">Scheme</label>
          <select class="form-select" id="scheme_select" name="scheme_id" required onchange="this.form.submit()"
        {% for scheme in schemes %}
          {% if user.scheme_id|string == scheme._id|string %} disabled {% endif %}
        {% endfor %}>
        <option value="" selected>All Schemes</option>
        {% for scheme in schemes %}
          <option value="{{ scheme._id }}"
        {% if session.get("reports_selected_scheme_id")|string == scheme._id|string or user.scheme_id|string == scheme._id|string %}selected{% endif %}>
        {{ scheme.scheme }}
          </option>
        {% endfor %}
          </select>
        </div>
          </form>

      <form method="POST" action="{{ url_for('search_customers_2') }}" style="max-width:180px;">
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-white px-1">
        <button type="submit" class="btn btn-link p-0" style="color:inherit;font-size:0.9em;">
          <i class="bi bi-search"></i>
        </button>
          </span>
          <input type="text" name="search" class="form-control" style="font-size:0.85em;padding:2px 6px;" placeholder="Search..." value="{{ session.get('reports_search_query', '') }}">
        </div>
      </form>


          {% if user.role in ["administrator", "billing_officer"] %}
        <button class="btn btn-success btn-xs me-1 py-1 px-2" data-bs-toggle="modal" data-bs-target="#addMonthlyBillingSheetModal" style="font-size: 0.75rem;">
          <i class="bi bi-file-earmark-excel me-1"></i> Add Monthly Billing
        </button>
        <button class="btn btn-primary btn-xs py-1 px-2" data-bs-toggle="modal" data-bs-target="#addMonthlyPaymentSheetModal" style="font-size: 0.75rem;">
          <i class="bi bi-upload me-1"></i> Add Monthly Payment
        </button>
          {% endif %}
        </div>
      </div>

      <!-- Add Monthly Payment Sheet Modal -->
      <div class="modal fade" id="addMonthlyPaymentSheetModal" tabindex="-1" aria-labelledby="addMonthlyPaymentSheetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('add_monthly_payment_sheet') }}" enctype="multipart/form-data">
              <div class="modal-header py-2">
                <h5 class="modal-title" id="addMonthlyPaymentSheetModalLabel">Add Monthly Payment Sheet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label for="monthly_payment_sheet_file" class="form-label">Monthly Payment Sheet File (CSV/Excel)</label>
                  <input type="file" class="form-control" id="monthly_payment_sheet_file" name="monthly_payment_sheet_file"
                    accept=".csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                </div>
              </div>
              <div class="modal-footer py-2">
                <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Monthly Billing Sheet Modal -->
      <div class="modal fade" id="addMonthlyBillingSheetModal" tabindex="-1" aria-labelledby="addMonthlyBillingSheetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('add_monthly_billing_sheet') }}" enctype="multipart/form-data">
              <div class="modal-header py-2">
                <h5 class="modal-title" id="addMonthlyBillingSheetModalLabel">Add Monthly Billing Sheet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label for="monthly_billing_sheet_file" class="form-label">Monthly Billing Sheet File (CSV/Excel)</label>
                  <input type="file" class="form-control" id="monthly_billing_sheet_file" name="monthly_billing_sheet_file"
                    accept=".csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                </div>
              </div>
              <div class="modal-footer py-2">
                <button type="submit" class="btn btn-success btn-sm">Submit</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Customer Reports Table -->
      <div class="table-responsive" style="max-height: 410px; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none;">
        <style>
          .table-responsive::-webkit-scrollbar {
        display: none;
          }
        </style>
        <table class="table table-secondary table-hover table-sm align-middle" style="font-size:0.70rem;">
          <thead class="table-light" style="position: sticky; top: 0; z-index: 2; background: #f8f9fa; font-size:0.70rem;">
            <tr class="table-primary">
              <th>Customer</th>
              <th class="d-none d-sm-table-cell">Reference No.</th>
              <th>Type</th>
              <th class="d-none d-sm-table-cell">Connection Date</th>
              <th>Connection Fee</th>
              <th class="d-none d-sm-table-cell">Initial Connection Clearance</th>
              <th>Connection Balance</th>
              <th>Bill Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody style="font-size:0.70rem;">
            {% for customer in customers %}
            <tr class="bg-dark-subtle my-1">
              <td class="fw-semibold text-truncate" style="max-width: 120px;">{{ customer.name or '-' }}</td>
              <td class="text-truncate d-none d-sm-table-cell" style="max-width: 120px;">{{ customer.customer_reference or '-' }}</td>
              <td class="text-truncate" style="max-width: 100px;">{{ customer.type or '-' }}</td>
              <td class="text-truncate d-none d-sm-table-cell" style="max-width: 100px;">
          {% if customer.connection_date %}
            {{ customer.connection_date.strftime('%d %b %Y') }}
          {% else %}
            -
          {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 100px;">
          {% if customer.connection_fee %}
            {{ "{:,}".format(customer.connection_fee|int) }}
          {% else %}
            -
          {% endif %}
              </td>
              <td class="text-truncate d-none d-sm-table-cell" style="max-width: 120px;">
          {% if customer.amount_paid %}
            {{ "{:,}".format(customer.amount_paid|int) }}
          {% else %}
            -
          {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 120px;">
          {% if customer.bpb %}
            {{ "{:,}".format(customer.bpb[-1].get('balance_on_connection', 0)|int) }}
          {% else %}
            {{"{:,}".format(customer.amount_due or 0|int) if customer.amount_due else '-'}}
          {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 120px;">
          {% if customer.bpb %}
            {{ "{:,}".format(customer.bpb[-1].get('balance_on_bill', 0)|int) }}
          {% else %}
            -
          {% endif %}
              </td>
              <td>
          <form method="POST" action="{{ url_for('customer_history') }}" style="display:inline;">
            <input type="hidden" name="customer_id" value="{{ customer._id }}">
            <input type="hidden" name="customer_reference" value="{{ customer.customer_reference }}">
            <button type="submit" class="btn btn-outline-info btn-sm" title="View History">
              <i class=""></i> View
            </button>
          </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

<div class="d-flex justify-content-center mt-3">
  <span class="me-3 align-self-center text-muted" style="font-size:0.85em;">
    Total: <strong>{{ total }}</strong>
  </span>
  <nav>
    <ul class="pagination pagination-sm mb-0">
      <li class="page-item {% if page <= 1 %}disabled{% endif %}">
        <a class="page-link" href="?page={{ page - 1 }}">«</a>
      </li>
      {% set start_page = page - 2 if page - 2 > 1 else 1 %}
      {% set end_page = start_page + 5 if start_page + 5 < total_pages else total_pages %}
      {% if end_page - start_page < 5 %}
        {% set start_page = end_page - 5 if end_page - 5 > 1 else 1 %}
      {% endif %}
      {% if start_page > 1 %}
        <li class="page-item"><a class="page-link" href="?page=1">1</a></li>
        {% if start_page > 2 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
      {% endif %}
      {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}">{{ p }}</a>
        </li>
      {% endfor %}
      {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
          <li class="page-item disabled"><span class="page-link">…</span></li>
        {% endif %}
        <li class="page-item"><a class="page-link" href="?page={{ total_pages }}">{{ total_pages }}</a></li>
      {% endif %}
      <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
        <a class="page-link" href="?page={{ page + 1 }}">»</a>
      </li>
    </ul>
  </nav>
</div>

    </div>
  </div>
</div>
{% endblock %}