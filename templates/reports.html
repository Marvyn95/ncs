{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <!-- Header and Action Buttons -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="fw-bold mb-0">Customer Reports</h4>
        <div>
          <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addMonthlyBillingSheetModal">
            <i class="bi bi-file-earmark-excel me-1"></i> Add Monthly Billing Sheet
          </button>
          <button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addMonthlyPaymentSheetModal">
            <i class="bi bi-upload me-1"></i> Add Monthly Payment Sheet
          </button>
        </div>
      </div>

      <!-- Add Monthly Payment Sheet Modal -->
      <div class="modal fade" id="addMonthlyPaymentSheetModal" tabindex="-1" aria-labelledby="addMonthlyPaymentSheetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('add_monthly_payment_sheet') }}" enctype="multipart/form-data">
              <div class="modal-header py-2">
                <h5 class="modal-title" id="addMonthlyPaymentSheetModalLabel">Add Monthly Payment Sheet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label for="monthly_payment_sheet_file" class="form-label">Monthly Payment Sheet File (CSV/Excel)</label>
                  <input type="file" class="form-control" id="monthly_payment_sheet_file" name="monthly_payment_sheet_file"
                    accept=".csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                </div>
              </div>
              <div class="modal-footer py-2">
                <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Monthly Billing Sheet Modal -->
      <div class="modal fade" id="addMonthlyBillingSheetModal" tabindex="-1" aria-labelledby="addMonthlyBillingSheetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="POST" action="{{ url_for('add_monthly_billing_sheet') }}" enctype="multipart/form-data">
              <div class="modal-header py-2">
                <h5 class="modal-title" id="addMonthlyBillingSheetModalLabel">Add Monthly Billing Sheet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2">
                  <label for="monthly_billing_sheet_file" class="form-label">Monthly Billing Sheet File (CSV/Excel)</label>
                  <input type="file" class="form-control" id="monthly_billing_sheet_file" name="monthly_billing_sheet_file"
                    accept=".csv,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required>
                </div>
              </div>
              <div class="modal-footer py-2">
                <button type="submit" class="btn btn-success btn-sm">Submit</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Customer Reports Table -->
      <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
        <table class="table table-secondary table-hover table-sm align-middle" style="font-size:0.75rem;">
          <thead class="table-light" style="position: sticky; top: 0; z-index: 2; background: #f8f9fa;">
            <tr class="table-primary">
              <th>Customer</th>
              <th>Reference No.</th>
              <th>Type</th>
              <th>Connection Date</th>
              <th>Connection Fee</th>
              <th>Initial Connection Clearance</th>
              <th> Current Connection Balance</th>
              <th>Current Bill Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for customer in customers %}
            <tr class="bg-dark-subtle my-1">
              <td class="fw-semibold text-truncate" style="max-width: 120px;">{{ customer.name or '-' }}</td>
              <td class="text-truncate" style="max-width: 120px;">{{ customer.customer_reference or '-' }}</td>
              <td class="text-truncate" style="max-width: 100px;">{{ customer.type or '-' }}</td>
              <td class="text-truncate" style="max-width: 100px;">
                {% if customer.connection_date %}
                  {{ customer.connection_date.strftime('%d %b %Y') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 100px;">
                {% if customer.connection_fee %}
                  {{ "{:,}".format(customer.connection_fee|int) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 120px;">
                {% if customer.amount_paid %}
                  {{ "{:,}".format(customer.amount_paid|int) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 120px;">
                {% if customer.bpb %}
                  {{ "{:,}".format(customer.bpb[-1].get('balance_on_connection', 0)|int) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 120px;">
                {% if customer.bpb %}
                  {{ "{:,}".format(customer.bpb[-1].get('balance_on_bill', 0)|int) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                <form method="POST" action="{{ url_for('customer_history') }}" style="display:inline;">
                  <input type="hidden" name="customer_id" value="{{ customer._id }}">
                  <input type="hidden" name="customer_reference" value="{{ customer.customer_reference }}">
                  <button type="submit" class="btn btn-outline-info btn-sm" title="View History">
                    <i class="bi bi-clock-history"></i> View
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}